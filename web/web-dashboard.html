<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPIRE Monitoring Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2em;
        }
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab:hover {
            background: #e9ecef;
        }
        .tab.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
        }
        .tab-content {
            padding: 30px;
            min-height: 400px;
            transition: opacity 0.2s ease;
        }
        .tab-pane {
            display: none;
        }
        .tab-pane.active {
            display: block;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .status-grid.overview {
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
        .status-grid.overview .status-card {
            min-height: 120px; /* Ensure consistent height across all overview tiles */
        }
        .status-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        .status-card.clickable {
            position: relative;
        }
        .status-card.clickable::after {
            content: '‚Üí';
            position: absolute;
            top: 20px;
            right: 20px;
            color: #667eea;
            font-size: 18px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .status-card.clickable:hover::after {
            opacity: 1;
        }
        .status-card.clickable:active {
            transform: translateY(0px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .clickable-hint {
            font-size: 12px;
            color: #667eea;
            margin-top: 5px;
            opacity: 0.7;
            font-style: italic;
        }
        .status-card h3 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 1.1em;
        }
        .status-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .status-online {
            color: #28a745;
        }
        .status-offline {
            color: #dc3545;
        }
        .status-warning {
            color: #ffc107;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .refresh-btn:hover {
            background: #5a6fd8;
        }
        .cluster-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 5px 5px 0;
        }
        .command-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .auto-refresh-controls {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .refresh-interval {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .refresh-status {
            font-weight: bold;
            color: #28a745;
        }
        .refresh-status.paused {
            color: #dc3545;
        }
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        .age-live {
            color: #007bff;
            font-weight: bold;
        }
        .metrics-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: none;
            width: 90%;
            max-width: 1000px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }
        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            line-height: 1;
        }
        .close:hover {
            opacity: 0.7;
        }
        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .metric-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-detail-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
        }
        .metric-detail-card h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 1.1em;
        }
        .metric-value-large {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        .metric-trend {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .trend-indicator {
            font-size: 1.2em;
            font-weight: bold;
        }
        .trend-up {
            color: #28a745;
        }
        .trend-down {
            color: #dc3545;
        }
        .trend-stable {
            color: #6c757d;
        }
        .trend-warning {
            color: #ffc107;
        }
        .selector-tag {
            display: inline-block;
            background: #e3f2fd;
            color: #1565c0;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
            border: 1px solid #bbdefb;
        }
        .metric-chart {
            height: 200px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-style: italic;
            margin: 20px 0;
        }
        .metrics-clickable {
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }
        .metrics-clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .metrics-clickable::after {
            content: 'üîç';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .metrics-clickable:hover::after {
            opacity: 1;
        }
        @keyframes fadeIn {
            from {opacity: 0;}
            to {opacity: 1;}
        }
        @keyframes slideIn {
            from {transform: translateY(-50px); opacity: 0;}
            to {transform: translateY(0); opacity: 1;}
        }
        
        /* Modal styles for kubectl describe drilldown */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }
        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 {
            margin: 0;
            font-size: 1.3em;
        }
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }
        .modal-close:hover {
            background-color: rgba(255,255,255,0.2);
        }
        .modal-body {
            padding: 20px;
            max-height: calc(90vh - 140px);
            overflow-y: auto;
        }
        .describe-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 60vh;
            margin-top: 10px;
        }
        .command-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .clickable-pod-name {
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
            transition: color 0.3s ease;
        }
        .clickable-pod-name:hover {
            color: #764ba2;
            font-weight: bold;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SPIRE Monitoring Dashboard</h1>
            <p>Multi-Cluster SPIFFE Runtime Environment</p>
            <div id="data-source-indicator" style="font-size: 14px; margin-top: 10px; opacity: 0.8;">
                üì° Loading pod data...
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">Overview</button>
            <button class="tab" onclick="showTab('server')">SPIRE Server</button>
            <button class="tab" onclick="showTab('database')">Database</button>
            <button class="tab" onclick="showTab('agents')">Agents</button>
            <button class="tab" onclick="showTab('workloads')">Workloads</button>
            <button class="tab" onclick="showTab('metrics')">SPIRE Metrics</button>
            <button class="tab" onclick="showTab('commands')">Useful Commands</button>
        </div>
        
        <div class="tab-content">
            <div id="overview" class="tab-pane active">
                <div class="auto-refresh-controls">
                    <button class="refresh-btn" onclick="refreshStatus()">üîÑ Manual Refresh</button>
                    <div class="refresh-interval">
                        <label>Auto-refresh:</label>
                        <select id="refresh-interval" onchange="updateRefreshInterval()">
                            <option value="0">Off</option>
                            <option value="5">5 seconds</option>
                            <option value="10" selected>10 seconds</option>
                            <option value="30">30 seconds</option>
                            <option value="60">1 minute</option>
                        </select>
                    </div>
                    <span id="refresh-status" class="refresh-status">Auto-refresh: 10s</span>
                    <span id="next-refresh">Next refresh in: 10s</span>
                </div>
                
                <div class="status-grid overview">
                    <div class="status-card clickable" onclick="navigateToTab('server')" title="Click to view SPIRE Server details">
                        <h3>SPIRE Server</h3>
                        <div class="status-value status-online" id="server-status">‚óè</div>
                        <p id="server-context">spire-server-cluster</p>
                        <div class="clickable-hint">Click for details</div>
                    </div>
                    <div class="status-card clickable" onclick="navigateToTab('database')" title="Click to view PostgreSQL Database details">
                        <h3>PostgreSQL DB</h3>
                        <div class="status-value status-online" id="database-status">‚óè</div>
                        <p id="database-context">Storage: <span id="db-storage">1Gi</span></p>
                        <div class="clickable-hint">Click for details</div>
                    </div>
                    <div class="status-card clickable" onclick="navigateToTab('agents')" title="Click to view SPIRE Agents details">
                        <h3>SPIRE Agents</h3>
                        <div class="status-value" id="agent-count">-</div>
                        <p>Active agents</p>
                        <div class="clickable-hint">Click for details</div>
                    </div>
                    <div class="status-card clickable" onclick="navigateToTab('workloads')" title="Click to view Workload Services details">
                        <h3>Workload Services</h3>
                        <div class="status-value" id="workload-count">-</div>
                        <p>Running services</p>
                        <div class="clickable-hint">Click for details</div>
                    </div>
                    <div class="status-card clickable" onclick="navigateToTab('metrics')" title="Click to view SPIRE Metrics & Telemetry">
                        <h3>SPIRE Metrics</h3>
                        <div class="status-value" id="metrics-summary">üìä</div>
                        <p id="metrics-context">Interactive telemetry</p>
                        <div class="clickable-hint">Click for details</div>
                    </div>
                </div>
                
                <div class="cluster-info">
                    <h4>Cluster Information</h4>
                    <p><strong>Server IP:</strong> <span id="server-ip">Loading...</span></p>
                    <p><strong>Setup Status:</strong> <span id="setup-status">Ready</span></p>
                    <p><strong>Last Updated:</strong> <span id="last-updated">-</span></p>
                </div>
            </div>
            
            <div id="server" class="tab-pane">
                <h2>SPIRE Server Status</h2>
                <button class="refresh-btn" onclick="refreshServerStatus()">üîÑ Refresh Server Status</button>
                <button class="refresh-btn" onclick="toggleAutoRefreshTab('server')" id="server-auto-btn">üü¢ Auto-refresh: ON</button>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th>Status</th>
                            <th>Ready</th>
                            <th>Restarts</th>
                            <th>Age</th>
                        </tr>
                    </thead>
                    <tbody id="server-table">
                        <tr>
                            <td colspan="5">Loading server status...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div id="database" class="tab-pane">
                <h2>PostgreSQL Database</h2>
                <button class="refresh-btn" onclick="refreshDatabaseStatus()">üîÑ Refresh Database Status</button>
                <button class="refresh-btn" onclick="toggleAutoRefreshTab('database')" id="database-auto-btn">üü¢ Auto-refresh: ON</button>
                
                <div class="status-grid">
                    <div class="status-card">
                        <h3>Database Status</h3>
                        <div class="status-value" id="db-status-icon">‚óè</div>
                        <p id="db-status-text">Loading...</p>
                    </div>
                    <div class="status-card">
                        <h3>Storage</h3>
                        <div class="status-value" id="db-storage-size">1Gi</div>
                        <p id="db-storage-status">Persistent Volume</p>
                    </div>
                    <div class="status-card">
                        <h3>Connections</h3>
                        <div class="status-value" id="db-connections">5432</div>
                        <p>Port (Internal)</p>
                    </div>
                    <div class="status-card">
                        <h3>Uptime</h3>
                        <div class="status-value" id="db-uptime">-</div>
                        <p>Database age</p>
                    </div>
                    <div class="status-card metrics-clickable" onclick="showDatabasePolicies()" title="Click to view all SPIRE policies stored in database">
                        <h3>SPIRE Policies</h3>
                        <div class="status-value" id="db-policies-count">-</div>
                        <p>Registration entries</p>
                        <div class="clickable-hint">Click for details</div>
                    </div>
                </div>

                <h3>Database Pod Details</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Pod Name</th>
                            <th>Status</th>
                            <th>Ready</th>
                            <th>Restarts</th>
                            <th>Node</th>
                            <th>Age</th>
                        </tr>
                    </thead>
                    <tbody id="database-table">
                        <tr>
                            <td colspan="6">Loading database information...</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Storage Details</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>PVC Name</th>
                            <th>Status</th>
                            <th>Capacity</th>
                            <th>Access Mode</th>
                            <th>Storage Class</th>
                            <th>Age</th>
                        </tr>
                    </thead>
                    <tbody id="storage-table">
                        <tr>
                            <td colspan="6">Loading storage information...</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Service Information</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Service Name</th>
                            <th>Type</th>
                            <th>Cluster IP</th>
                            <th>Port</th>
                            <th>Age</th>
                        </tr>
                    </thead>
                    <tbody id="db-service-table">
                        <tr>
                            <td colspan="5">Loading service information...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div id="agents" class="tab-pane">
                <h2>SPIRE Agents</h2>
                <button class="refresh-btn" onclick="refreshAgentStatus()">üîÑ Refresh Agent Status</button>
                <button class="refresh-btn" onclick="toggleAutoRefreshTab('agents')" id="agents-auto-btn">üü¢ Auto-refresh: ON</button>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>Agent</th>
                            <th>Node</th>
                            <th>Status</th>
                            <th>Ready</th>
                            <th>Age</th>
                        </tr>
                    </thead>
                    <tbody id="agents-table">
                        <tr>
                            <td colspan="5">Loading agent status...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div id="workloads" class="tab-pane">
                <h2>Workload Services</h2>
                <button class="refresh-btn" onclick="refreshWorkloadStatus()">üîÑ Refresh Workload Status</button>
                <button class="refresh-btn" onclick="toggleAutoRefreshTab('workloads')" id="workloads-auto-btn">üü¢ Auto-refresh: ON</button>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>Service</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Ready</th>
                            <th>Restarts</th>
                            <th>Age</th>
                        </tr>
                    </thead>
                    <tbody id="workloads-table">
                        <tr>
                            <td colspan="6">Loading workload status...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div id="metrics" class="tab-pane">
                <h2>SPIRE Metrics & Telemetry</h2>
                <button class="refresh-btn" onclick="refreshMetricsStatus()">üîÑ Refresh Metrics</button>
                <button class="refresh-btn" onclick="toggleAutoRefreshTab('metrics')" id="metrics-auto-btn">üü¢ Auto-refresh: ON</button>
                
                <div class="cluster-info">
                    <h4>SPIRE Telemetry Overview</h4>
                    <p>Monitor key SPIFFE/SPIRE operational metrics for identity management, certificate issuance, and agent health.</p>
                </div>

                <div class="status-grid">
                    <div class="status-card metrics-clickable" onclick="showMetricDetail('server-rpc')" title="Click for detailed RPC metrics">
                        <h3>Server RPC Calls</h3>
                        <div class="status-value" id="server-rpc-calls">-</div>
                        <p>Total server RPC operations</p>
                    </div>
                    <div class="status-card metrics-clickable" onclick="showMetricDetail('agent-connections')" title="Click for detailed connection metrics">
                        <h3>Agent Connections</h3>
                        <div class="status-value" id="agent-connections">-</div>
                        <p>Active agent connections</p>
                    </div>
                    <div class="status-card metrics-clickable" onclick="showMetricDetail('svid-issuance')" title="Click for detailed SVID issuance metrics">
                        <h3>SVID Issuance Rate</h3>
                        <div class="status-value" id="svid-rate">-</div>
                        <p>SVIDs issued per minute</p>
                    </div>
                    <div class="status-card metrics-clickable" onclick="showMetricDetail('certificate-expiry')" title="Click for detailed certificate expiry metrics">
                        <h3>Certificate Expiry</h3>
                        <div class="status-value" id="cert-expiry">-</div>
                        <p>Certificates expiring soon</p>
                    </div>
                </div>

                <h3>SPIRE Server Metrics</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Type</th>
                            <th>Current Value</th>
                            <th>Status</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody id="server-metrics-table">
                        <tr>
                            <td>spire_server.rpc.attest_agent</td>
                            <td>Counter</td>
                            <td id="attest-agent-count">-</td>
                            <td><span class="status-online">‚óè</span> OK</td>
                            <td>Agent attestation requests</td>
                        </tr>
                        <tr>
                            <td>spire_server.rpc.fetch_jwt_svid</td>
                            <td>Counter</td>
                            <td id="jwt-svid-count">-</td>
                            <td><span class="status-online">‚óè</span> OK</td>
                            <td>JWT-SVID fetch operations</td>
                        </tr>
                        <tr>
                            <td>spire_server.rpc.fetch_x509_svid</td>
                            <td>Counter</td>
                            <td id="x509-svid-count">-</td>
                            <td><span class="status-online">‚óè</span> OK</td>
                            <td>X.509-SVID fetch operations</td>
                        </tr>
                        <tr>
                            <td>spire_server.ca.sign_x509_ca_svid</td>
                            <td>Counter</td>
                            <td id="ca-sign-count">-</td>
                            <td><span class="status-online">‚óè</span> OK</td>
                            <td>CA certificate signing operations</td>
                        </tr>
                        <tr>
                            <td>spire_server.datastore.bundle.fetch</td>
                            <td>Counter</td>
                            <td id="bundle-fetch-count">-</td>
                            <td><span class="status-online">‚óè</span> OK</td>
                            <td>Trust bundle fetch operations</td>
                        </tr>
                    </tbody>
                </table>

                <h3>SPIRE Agent Metrics</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Type</th>
                            <th>Current Value</th>
                            <th>Status</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody id="agent-metrics-table">
                        <tr>
                            <td>spire_agent.rpc.fetch_x509_svid</td>
                            <td>Counter</td>
                            <td id="agent-x509-count">-</td>
                            <td><span class="status-online">‚óè</span> OK</td>
                            <td>Agent X.509-SVID requests</td>
                        </tr>
                        <tr>
                            <td>spire_agent.cache_manager.expiring_svids</td>
                            <td>Gauge</td>
                            <td id="expiring-svids">-</td>
                            <td><span class="status-warning">‚óè</span> Monitor</td>
                            <td>Number of SVIDs expiring soon</td>
                        </tr>
                        <tr>
                            <td>spire_agent.cache_manager.outdated_svids</td>
                            <td>Gauge</td>
                            <td id="outdated-svids">-</td>
                            <td><span class="status-warning">‚óè</span> Monitor</td>
                            <td>Number of outdated SVIDs</td>
                        </tr>
                        <tr>
                            <td>spire_agent.sds_api.connections</td>
                            <td>Gauge</td>
                            <td id="sds-connections">-</td>
                            <td><span class="status-online">‚óè</span> OK</td>
                            <td>Active SDS API connections</td>
                        </tr>
                        <tr>
                            <td>spire_agent.sync_manager.fetch_entries</td>
                            <td>Counter</td>
                            <td id="sync-entries">-</td>
                            <td><span class="status-online">‚óè</span> OK</td>
                            <td>Entry synchronization operations</td>
                        </tr>
                    </tbody>
                </table>

                <div class="cluster-info">
                    <h4>Metrics Collection Configuration</h4>
                    <p><strong>Prometheus Endpoint:</strong> http://spire-server:9988/metrics</p>
                    <p><strong>Agent Metrics:</strong> Available on each node via DaemonSet</p>
                    <p><strong>Collection Interval:</strong> 30 seconds</p>
                    <p><strong>Retention:</strong> 15 days</p>
                </div>

                <h3>Alert Thresholds</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Alert</th>
                            <th>Condition</th>
                            <th>Severity</th>
                            <th>Current Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>SPIRE Server Down</td>
                            <td>Server unavailable > 1min</td>
                            <td>Critical</td>
                            <td><span class="status-online">‚óè</span> OK</td>
                        </tr>
                        <tr>
                            <td>High SVID Expiration</td>
                            <td>Expiring SVIDs > 50</td>
                            <td>Warning</td>
                            <td><span class="status-online">‚óè</span> OK</td>
                        </tr>
                        <tr>
                            <td>Agent Attestation Failures</td>
                            <td>Failed attestations > 10/min</td>
                            <td>Warning</td>
                            <td><span class="status-online">‚óè</span> OK</td>
                        </tr>
                        <tr>
                            <td>CA Certificate Expiry</td>
                            <td>CA cert expires < 30 days</td>
                            <td>Critical</td>
                            <td><span class="status-online">‚óè</span> OK</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div id="commands" class="tab-pane">
                <h2>Useful Commands</h2>
                
                <h3>Get Real Pod Data (JSON)</h3>
                <div class="command-box">./scripts/get-pod-data.sh</div>
                <p><em>This script provides the real-time pod data that should be displayed in the dashboard.</em></p>
                
                <h3>Check SPIRE Server Status</h3>
                <div class="command-box">kubectl --context spire-server-cluster -n spire get pods -l app=spire-server</div>
                
                <h3>Check PostgreSQL Database</h3>
                <div class="command-box">kubectl --context spire-server-cluster -n spire get pods -l app=spire-db</div>
                
                <h3>Check Database Storage</h3>
                <div class="command-box">kubectl --context spire-server-cluster -n spire get pvc postgres-pvc</div>
                
                <h3>Check Database Service</h3>
                <div class="command-box">kubectl --context spire-server-cluster -n spire get svc spire-db</div>
                
                <h3>Check SPIRE Agents</h3>
                <div class="command-box">kubectl --context workload-cluster -n spire get pods</div>
                
                <h3>Check Workload Services</h3>
                <div class="command-box">kubectl --context workload-cluster -n workload get pods</div>
                
                <h3>View SPIRE Server Logs</h3>
                <div class="command-box">kubectl --context spire-server-cluster -n spire logs spire-server-0</div>
                
                <h3>View Database Logs</h3>
                <div class="command-box">kubectl --context spire-server-cluster -n spire logs -l app=spire-db</div>
                
                <h3>Connect to Database (Internal)</h3>
                <div class="command-box">kubectl --context spire-server-cluster -n spire exec -it spire-server-0 -- psql -h spire-db -U postgres</div>
                
                <h3>View Agent Logs</h3>
                <div class="command-box">kubectl --context workload-cluster -n spire logs -l app=spire-agent</div>
                
                <h3>Run Verification Script</h3>
                <div class="command-box">./scripts/verify-setup.sh</div>
                
                <h3>Check SPIRE Server Metrics (Prometheus)</h3>
                <div class="command-box">curl http://localhost:9988/metrics</div>
                
                <h3>Check SPIRE Agent Metrics</h3>
                <div class="command-box">kubectl --context workload-cluster -n spire port-forward spire-agent-<pod-id> 9988:9988 &
curl http://localhost:9988/metrics</div>
                
                <h3>View SPIRE Server Telemetry Configuration</h3>
                <div class="command-box">kubectl --context spire-server-cluster -n spire get configmap spire-server -o yaml | grep -A 20 telemetry</div>
                
                <div class="cluster-info">
                    <h4>Age Calculation Debug</h4>
                    <p><strong>Current Time:</strong> <span id="current-time">-</span></p>
                    <p><strong>Server Created:</strong> 2025-07-12T23:34:16Z</p>
                    <p><strong>DB Created:</strong> 2025-07-12T23:32:51Z</p>
                    <p><strong>Expected Ages:</strong> Should match kubectl output (4h+ with minutes)</p>
                </div>
                
                <div class="cluster-info">
                    <h4>Note on Real-Time Data</h4>
                    <p>The dashboard currently shows simulated ages based on actual pod timestamps (matching your current environment). For true real-time data, you would need to set up a simple HTTP server that serves the output of <code>scripts/get-pod-data.sh</code> and have the dashboard fetch from that endpoint.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Metrics Detail Modals -->
    <div id="metrics-modal" class="metrics-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Metric Details</h2>
                <button class="close" onclick="closeMetricModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Database Policies Modal -->
    <div id="database-policies-modal" class="metrics-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="policies-modal-title">SPIRE Database Policies</h2>
                <button class="close" onclick="closeDatabasePoliciesModal()">&times;</button>
            </div>
            <div class="modal-body" id="policies-modal-body">
                <!-- Dynamic policies content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables for auto-refresh
        let autoRefreshInterval = null;
        let refreshIntervalSeconds = 10;
        let nextRefreshCounter = null;
        let dashboardStartTime = new Date();
        let tabAutoRefresh = {
            server: true,
            database: true,
            agents: true,
            workloads: true,
            metrics: true
        };

        function showTab(tabName) {
            // Hide all tab panes
            const panes = document.querySelectorAll('.tab-pane');
            panes.forEach(pane => pane.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab pane
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab - handle both click events and programmatic calls
            if (event && event.target && event.target.classList.contains('tab')) {
                event.target.classList.add('active');
            } else {
                // Find the tab button for this tab and activate it
                const tabButtons = document.querySelectorAll('.tab');
                tabButtons.forEach(tab => {
                    const tabText = tab.textContent.toLowerCase();
                    if ((tabName === 'overview' && tabText.includes('overview')) ||
                        (tabName === 'server' && tabText.includes('spire server')) ||
                        (tabName === 'database' && tabText.includes('database')) ||
                        (tabName === 'agents' && tabText.includes('agents')) ||
                        (tabName === 'workloads' && tabText.includes('workloads')) ||
                        (tabName === 'metrics' && tabText.includes('metrics')) ||
                        (tabName === 'commands' && tabText.includes('commands'))) {
                        tab.classList.add('active');
                    }
                });
            }
        }

        function navigateToTab(tabName) {
            // Add smooth transition effect
            const container = document.querySelector('.tab-content');
            container.style.opacity = '0.7';
            
            setTimeout(() => {
                // Navigate to the specified tab
                showTab(tabName);
                
                // Refresh the data for that tab immediately
                switch(tabName) {
                    case 'server':
                        refreshServerStatus();
                        break;
                    case 'database':
                        refreshDatabaseStatus();
                        break;
                    case 'agents':
                        refreshAgentStatus();
                        break;
                    case 'workloads':
                        refreshWorkloadStatus();
                        break;
                    case 'metrics':
                        refreshMetricsStatus();
                        break;
                }
                
                // Restore opacity
                container.style.opacity = '1';
                
                // Add a visual feedback effect
                const targetTab = document.getElementById(tabName);
                if (targetTab) {
                    targetTab.style.backgroundColor = '#f8f9fa';
                    setTimeout(() => {
                        targetTab.style.backgroundColor = '';
                    }, 300);
                }
            }, 150);
        }

        function updateRefreshInterval() {
            const select = document.getElementById('refresh-interval');
            refreshIntervalSeconds = parseInt(select.value);
            
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            
            if (nextRefreshCounter) {
                clearInterval(nextRefreshCounter);
                nextRefreshCounter = null;
            }
            
            if (refreshIntervalSeconds > 0) {
                startAutoRefresh();
                document.getElementById('refresh-status').textContent = `Auto-refresh: ${refreshIntervalSeconds}s`;
                document.getElementById('refresh-status').classList.remove('paused');
            } else {
                document.getElementById('refresh-status').textContent = 'Auto-refresh: OFF';
                document.getElementById('refresh-status').classList.add('paused');
                document.getElementById('next-refresh').textContent = '';
            }
        }

        function startAutoRefresh() {
            if (refreshIntervalSeconds <= 0) return;
            
            // Set up auto-refresh
            autoRefreshInterval = setInterval(() => {
                refreshAllData();
            }, refreshIntervalSeconds * 1000);
            
            // Set up countdown timer
            let secondsLeft = refreshIntervalSeconds;
            nextRefreshCounter = setInterval(() => {
                secondsLeft--;
                if (secondsLeft <= 0) {
                    secondsLeft = refreshIntervalSeconds;
                }
                document.getElementById('next-refresh').textContent = `Next refresh in: ${secondsLeft}s`;
            }, 1000);
            
            document.getElementById('next-refresh').textContent = `Next refresh in: ${refreshIntervalSeconds}s`;
        }

        function refreshAllData() {
            refreshStatus();
            if (tabAutoRefresh.server) refreshServerStatus();
            if (tabAutoRefresh.database) refreshDatabaseStatus();
            if (tabAutoRefresh.agents) refreshAgentStatus();
            if (tabAutoRefresh.workloads) refreshWorkloadStatus();
            if (tabAutoRefresh.metrics) refreshMetricsStatus();
        }

        function toggleAutoRefreshTab(tab) {
            tabAutoRefresh[tab] = !tabAutoRefresh[tab];
            const btn = document.getElementById(`${tab}-auto-btn`);
            if (tabAutoRefresh[tab]) {
                btn.textContent = 'üü¢ Auto-refresh: ON';
                btn.style.background = '#28a745';
            } else {
                btn.textContent = 'üî¥ Auto-refresh: OFF';
                btn.style.background = '#dc3545';
            }
        }

        function calculateAge(startTime) {
            const now = new Date();
            const diffMs = now - startTime;
            const diffSecs = Math.floor(diffMs / 1000);
            const diffMins = Math.floor(diffSecs / 60);
            const diffHours = Math.floor(diffMins / 60);
            
            if (diffHours > 0) {
                return `${diffHours}h${diffMins % 60}m`;
            } else if (diffMins > 0) {
                return `${diffMins}m${diffSecs % 60}s`;
            } else {
                return `${diffSecs}s`;
            }
        }

        function calculateRealAge(creationTimestamp) {
            const created = new Date(creationTimestamp);
            const now = new Date();
            const diffMs = now - created;
            
            const totalSecs = Math.floor(diffMs / 1000);
            const totalMins = Math.floor(totalSecs / 60);
            const totalHours = Math.floor(totalMins / 60);
            const totalDays = Math.floor(totalHours / 24);
            
            // Calculate remaining minutes and seconds after hours/days
            const remainingMins = totalMins % 60;
            const remainingSecs = totalSecs % 60;
            const remainingHours = totalHours % 24;
            
            if (totalDays > 0) {
                return `${totalDays}d${remainingHours}h`;
            } else if (totalHours > 0) {
                return `${totalHours}h${remainingMins}m`;
            } else if (totalMins > 0) {
                return `${totalMins}m${remainingSecs}s`;
            } else {
                return `${totalSecs}s`;
            }
        }

        async function fetchPodData() {
            try {
                // Try to fetch real data from the API endpoint first
                try {
                    const response = await fetch('/api/pod-data');
                    if (response.ok) {
                        const realData = await response.json();
                        console.log('Using real pod data from API');
                        updateDataSourceIndicator('real');
                        return enrichPodData(realData);
                    }
                } catch (apiError) {
                    console.log('API not available, falling back to mock data:', apiError.message);
                }
                
                // Fallback to mock data if API is not available
                console.log('Using mock pod data');
                updateDataSourceIndicator('mock');
                return await simulateKubectlCall();
            } catch (error) {
                console.error('Failed to fetch pod data:', error);
                return null;
            }
        }
        
        function updateDataSourceIndicator(source) {
            const indicator = document.getElementById('data-source-indicator');
            if (source === 'real') {
                indicator.innerHTML = '‚úÖ Real-time data from Kubernetes clusters';
                indicator.style.color = '#28a745';
            } else if (source === 'mock') {
                indicator.innerHTML = 'üîß Mock data (API server not running)';
                indicator.style.color = '#ffc107';
            } else {
                indicator.innerHTML = 'üì° Loading pod data...';
                indicator.style.color = '#ffffff';
            }
        }
        
        function enrichPodData(realData) {
            // Enrich the real data with additional metadata for better display
            
            // Fix server pods to extract metadata properly
            if (realData.server) {
                realData.server = realData.server.map(pod => ({
                    name: pod.metadata.name,
                    status: pod.status.phase,
                    ready: pod.status.containerStatuses?.[0]?.ready || false,
                    restarts: pod.status.containerStatuses?.[0]?.restartCount || 0,
                    node: pod.spec.nodeName,
                    age: pod.metadata.creationTimestamp
                }));
            }
            
            // Fix database pods
            if (realData.database) {
                realData.database = realData.database.map(pod => ({
                    name: pod.metadata.name,
                    status: pod.status.phase,
                    ready: pod.status.containerStatuses?.[0]?.ready || false,
                    restarts: pod.status.containerStatuses?.[0]?.restartCount || 0,
                    node: pod.spec.nodeName,
                    image: pod.spec.containers?.[0]?.image || '',
                    age: pod.metadata.creationTimestamp
                }));
            }
            
            // Fix storage
            if (realData.storage) {
                realData.storage = realData.storage.map(pvc => ({
                    name: pvc.metadata.name,
                    status: pvc.status.phase,
                    capacity: pvc.status.capacity?.storage || pvc.spec.resources.requests.storage,
                    accessModes: pvc.spec.accessModes?.[0] || '',
                    storageClass: pvc.spec.storageClassName || '',
                    age: pvc.metadata.creationTimestamp
                }));
            }
            
            // Fix database service
            if (realData.dbService) {
                realData.dbService = realData.dbService.map(svc => ({
                    name: svc.metadata.name,
                    type: svc.spec.type,
                    clusterIP: svc.spec.clusterIP,
                    port: svc.spec.ports?.[0]?.port || 0,
                    targetPort: svc.spec.ports?.[0]?.targetPort || 0,
                    age: svc.metadata.creationTimestamp
                }));
            }
            
            // Fix agents
            if (realData.agents) {
                realData.agents = realData.agents.map(pod => ({
                    name: pod.metadata.name,
                    node: pod.spec.nodeName,
                    status: pod.status.phase,
                    ready: pod.status.containerStatuses?.[0]?.ready || false,
                    age: pod.metadata.creationTimestamp
                }));
            }
            
            // Fix workloads
            if (realData.workloads) {
                realData.workloads = realData.workloads.map(pod => {
                    // Extract service info from pod name and add descriptions
                    let serviceType = 'api';
                    let description = '';
                    
                    if (pod.metadata.name.includes('user-service')) {
                        pod.serviceName = 'user-service';
                        description = 'User Management API';
                    } else if (pod.metadata.name.includes('payment-api')) {
                        pod.serviceName = 'payment-api';
                        description = 'Payment Processing API';
                    } else if (pod.metadata.name.includes('inventory-service')) {
                        pod.serviceName = 'inventory-service';
                        description = 'Inventory Management API';
                    } else {
                        // Fallback for other services
                        pod.serviceName = pod.serviceName || pod.metadata.name.split('-')[0] + '-service';
                        description = `${pod.serviceName.charAt(0).toUpperCase() + pod.serviceName.slice(1)} Service`;
                    }
                    
                    return {
                        name: pod.metadata.name,
                        serviceName: pod.serviceName,
                        serviceType,
                        description,
                        status: pod.status.phase,
                        ready: pod.status.containerStatuses?.[0]?.ready || false,
                        restarts: pod.status.containerStatuses?.[0]?.restartCount || 0,
                        upToDate: 1,
                        available: 1,
                        age: pod.metadata.creationTimestamp
                    };
                });
            }
            
            return realData;
        }

        async function simulateKubectlCall() {
            // Fallback mock data when real API is not available
            console.log('Generating mock pod data...');
            
            // Generate realistic timestamps for demo purposes
            const now = new Date();
            const serverCreated = new Date(now.getTime() - (4 * 60 * 60 * 1000)).toISOString(); // 4 hours ago
            const dbCreated = new Date(now.getTime() - (4 * 60 * 60 * 1000) - (2 * 60 * 1000)).toISOString(); // 4h 2m ago
            const workloadCreated = new Date(now.getTime() - (3 * 60 * 60 * 1000) - (30 * 60 * 1000)).toISOString(); // 3h 30m ago
            const agentCreated = new Date(now.getTime() - (3 * 60 * 60 * 1000) - (45 * 60 * 1000)).toISOString(); // 3h 45m ago
            
            return {
                server: [
                    {
                        name: "spire-server-0", 
                        status: "Running",
                        ready: true,
                        restarts: 0,
                        node: "spire-server-cluster",
                        age: serverCreated
                    }
                ],
                database: [
                    {
                        name: "spire-db-ffd45757f-wwdv6",
                        status: "Running",
                        ready: true,
                        restarts: 0,
                        node: "spire-server-cluster",
                        image: "postgres:14",
                        age: dbCreated
                    }
                ],
                storage: [
                    {
                        name: "postgres-pvc",
                        status: "Bound",
                        capacity: "1Gi",
                        accessModes: "ReadWriteOnce",
                        storageClass: "standard",
                        age: dbCreated
                    }
                ],
                dbService: [
                    {
                        name: "spire-db",
                        type: "ClusterIP",
                        clusterIP: "10.102.112.214",
                        port: 5432,
                        targetPort: 5432,
                        age: dbCreated
                    }
                ],
                agents: [
                    {
                        name: "spire-agent-79mq8",
                        node: "workload-cluster",
                        status: "Pending",
                        ready: false,
                        age: agentCreated
                    }
                ],
                workloads: [
                    {
                        name: "user-service-6cf95d7d88-5qksc",
                        serviceName: "user-service",
                        serviceType: "api",
                        description: "User Management API",
                        status: "Running",
                        ready: true,
                        restarts: 0,
                        upToDate: 1,
                        available: 1,
                        age: workloadCreated
                    },
                    {
                        name: "payment-api-56c7f688d-5v2bg",
                        serviceName: "payment-api", 
                        serviceType: "api",
                        description: "Payment Processing API",
                        status: "Running",
                        ready: true,
                        restarts: 0,
                        upToDate: 1,
                        available: 1,
                        age: new Date(now.getTime() - (3 * 60 * 60 * 1000) - (25 * 60 * 1000)).toISOString()
                    },
                    {
                        name: "inventory-service-84f7b45d49-bw9v2",
                        serviceName: "inventory-service",
                        serviceType: "api",
                        description: "Inventory Management API",
                        status: "Running",
                        ready: true,
                        restarts: 0,
                        upToDate: 1,
                        available: 1,
                        age: new Date(now.getTime() - (2 * 60 * 60 * 1000) - (45 * 60 * 1000)).toISOString()
                    }
                ]
            };
        }
        
        async function refreshStatus() {
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
            
            // Update debug info
            const currentTimeElement = document.getElementById('current-time');
            if (currentTimeElement) {
                currentTimeElement.textContent = new Date().toISOString();
            }
            
            try {
                const data = await fetchPodData();
                if (data) {
                    // Update counts with real data
                    document.getElementById('agent-count').textContent = data.agents.length;
                    document.getElementById('workload-count').textContent = data.workloads.length;
                    
                    // Update metrics summary
                    updateMetricsSummary();
                    
                    // Store data globally for other functions
                    window.currentPodData = data;
                }
            } catch (error) {
                console.error('Failed to refresh status:', error);
            }
            
            console.log('Refreshing status...');
        }
        
        async function refreshServerStatus() {
            const table = document.getElementById('server-table');
            table.classList.add('loading');
            
            try {
                const data = window.currentPodData || await fetchPodData();
                
                if (data && data.server) {
                    let tableHTML = '';
                    data.server.forEach(pod => {
                        const statusIcon = pod.ready ? '<span class="status-online">‚óè</span>' : '<span class="status-offline">‚óè</span>';
                        const readyText = pod.ready ? '1/1' : '0/1';
                        const age = calculateRealAge(pod.age);
                        
                        tableHTML += `
                            <tr>
                                <td>${createClickablePodName(pod.name)}</td>
                                <td>${statusIcon} ${pod.status}</td>
                                <td>${readyText}</td>
                                <td>${pod.restarts}</td>
                                <td class="age-live">${age}</td>
                            </tr>
                        `;
                    });
                    table.innerHTML = tableHTML;
                } else {
                    table.innerHTML = '<tr><td colspan="5">No server data available</td></tr>';
                }
            } catch (error) {
                console.error('Failed to refresh server status:', error);
                table.innerHTML = '<tr><td colspan="5">Error loading server data</td></tr>';
            }
            
            table.classList.remove('loading');
        }
        
        async function refreshDatabaseStatus() {
            const databaseTable = document.getElementById('database-table');
            const storageTable = document.getElementById('storage-table');
            const serviceTable = document.getElementById('db-service-table');
            
            databaseTable.classList.add('loading');
            storageTable.classList.add('loading');
            serviceTable.classList.add('loading');
            
            try {
                const data = window.currentPodData || await fetchPodData();
                
                // Update database status cards
                if (data && data.database && data.database.length > 0) {
                    const dbPod = data.database[0];
                    const age = calculateRealAge(dbPod.age);
                    
                    document.getElementById('db-status-icon').className = dbPod.ready ? 'status-value status-online' : 'status-value status-offline';
                    document.getElementById('db-status-text').textContent = dbPod.status;
                    document.getElementById('db-uptime').textContent = age;
                    
                    // Update policy count (simulated - in production this would query actual database)
                    document.getElementById('db-policies-count').textContent = '7';
                    
                    // Update database table
                    let dbTableHTML = '';
                    data.database.forEach(pod => {
                        const statusIcon = pod.ready ? '<span class="status-online">‚óè</span>' : '<span class="status-offline">‚óè</span>';
                        const podAge = calculateRealAge(pod.age);
                        
                        dbTableHTML += `
                            <tr>
                                <td>${createClickablePodName(pod.name)}</td>
                                <td>${statusIcon} ${pod.status}</td>
                                <td>${pod.ready ? '1/1' : '0/1'}</td>
                                <td>${pod.restarts}</td>
                                <td>${pod.node}</td>
                                <td class="age-live">${podAge}</td>
                            </tr>
                        `;
                    });
                    databaseTable.innerHTML = dbTableHTML;
                } else {
                    databaseTable.innerHTML = '<tr><td colspan="6">No database pods found</td></tr>';
                }
                
                // Update storage table
                if (data && data.storage && data.storage.length > 0) {
                    let storageHTML = '';
                    data.storage.forEach(pvc => {
                        const storageAge = calculateRealAge(pvc.age);
                        
                        storageHTML += `
                            <tr>
                                <td>${pvc.name}</td>
                                <td><span class="status-online">‚óè</span> ${pvc.status}</td>
                                <td>${pvc.capacity}</td>
                                <td>${pvc.accessModes}</td>
                                <td>${pvc.storageClass}</td>
                                <td class="age-live">${storageAge}</td>
                            </tr>
                        `;
                    });
                    storageTable.innerHTML = storageHTML;
                    
                    // Update storage status card
                    document.getElementById('db-storage-size').textContent = data.storage[0].capacity;
                } else {
                    storageTable.innerHTML = '<tr><td colspan="6">No storage information found</td></tr>';
                }
                
                // Update service table
                if (data && data.dbService && data.dbService.length > 0) {
                    let serviceHTML = '';
                    data.dbService.forEach(svc => {
                        const serviceAge = calculateRealAge(svc.age);
                        
                        serviceHTML += `
                            <tr>
                                <td>${svc.name}</td>
                                <td>${svc.type}</td>
                                <td>${svc.clusterIP}</td>
                                <td>${svc.port}/${svc.targetPort}</td>
                                <td class="age-live">${serviceAge}</td>
                            </tr>
                        `;
                    });
                    serviceTable.innerHTML = serviceHTML;
                    
                    // Update connection status card
                    document.getElementById('db-connections').textContent = data.dbService[0].port;
                } else {
                    serviceTable.innerHTML = '<tr><td colspan="5">No service information found</td></tr>';
                }
                
            } catch (error) {
                console.error('Failed to refresh database status:', error);
                databaseTable.innerHTML = '<tr><td colspan="6">Error loading database data</td></tr>';
                storageTable.innerHTML = '<tr><td colspan="6">Error loading storage data</td></tr>';
                serviceTable.innerHTML = '<tr><td colspan="5">Error loading service data</td></tr>';
            }
            
            databaseTable.classList.remove('loading');
            storageTable.classList.remove('loading');
            serviceTable.classList.remove('loading');
        }
        
        async function refreshAgentStatus() {
            const table = document.getElementById('agents-table');
            table.classList.add('loading');
            
            try {
                const data = window.currentPodData || await fetchPodData();
                
                if (data && data.agents) {
                    let tableHTML = '';
                    data.agents.forEach(pod => {
                        const statusIcon = pod.ready ? '<span class="status-online">‚óè</span>' : '<span class="status-warning">‚óè</span>';
                        const readyText = pod.ready ? '1/1' : '0/1';
                        const age = calculateRealAge(pod.age);
                        
                        tableHTML += `
                            <tr>
                                <td>${createClickablePodName(pod.name)}</td>
                                <td>${pod.node}</td>
                                <td>${statusIcon} ${pod.status}</td>
                                <td>${readyText}</td>
                                <td class="age-live">${age}</td>
                            </tr>
                        `;
                    });
                    table.innerHTML = tableHTML;
                } else {
                    table.innerHTML = '<tr><td colspan="5">No agent data available</td></tr>';
                }
            } catch (error) {
                console.error('Failed to refresh agent status:', error);
                table.innerHTML = '<tr><td colspan="5">Error loading agent data</td></tr>';
            }
            
            table.classList.remove('loading');
        }
        
        async function refreshWorkloadStatus() {
            const table = document.getElementById('workloads-table');
            table.classList.add('loading');
            
            try {
                const data = window.currentPodData || await fetchPodData();
                
                if (data && data.workloads) {
                    let tableHTML = '';
                    data.workloads.forEach(pod => {
                        const age = calculateRealAge(pod.age);
                        // Use serviceName if available, otherwise extract from pod name
                        const serviceName = pod.serviceName || pod.name.split('-')[0];
                        const serviceType = pod.serviceType || 'Unknown';
                        const description = pod.description || '';
                        
                        const statusIcon = pod.ready ? '<span class="status-online">‚óè</span>' : '<span class="status-offline">‚óè</span>';
                        
                        tableHTML += `
                            <tr>
                                <td>
                                    <strong>${serviceName}</strong>
                                    ${description ? `<br><small style="color: #666;">${description}</small>` : ''}
                                    <br><small style="color: #999;">${createClickablePodName(pod.name)}</small>
                                </td>
                                <td><span style="background: #e9ecef; padding: 2px 6px; border-radius: 3px; font-size: 12px;">${serviceType}</span></td>
                                <td>${statusIcon} ${pod.status}</td>
                                <td>${pod.ready ? '1/1' : '0/1'}</td>
                                <td>${pod.restarts || 0}</td>
                                <td class="age-live">${age}</td>
                            </tr>
                        `;
                    });
                    table.innerHTML = tableHTML;
                } else {
                    table.innerHTML = '<tr><td colspan="6">No workload data available</td></tr>';
                }
            } catch (error) {
                console.error('Failed to refresh workload status:', error);
                table.innerHTML = '<tr><td colspan="6">Error loading workload data</td></tr>';
            }
            
            table.classList.remove('loading');
        }

        function updateMetricsSummary() {
            // Update metrics summary for overview tab
            const metricsData = window.currentMetricsData || {};
            
            // Calculate a simple metrics health score
            const rpcCalls = metricsData.serverRpcCalls || 0;
            const agentConnections = metricsData.agentConnections || 0;
            const svidRate = metricsData.svidRate || 0;
            
            // Determine metrics status based on activity
            let metricsIcon = "üìä";
            let metricsText = "Interactive telemetry";
            
            if (rpcCalls > 5000 && agentConnections > 5 && svidRate > 50) {
                metricsIcon = "üü¢";
                metricsText = "High activity";
            } else if (rpcCalls > 1000 && agentConnections > 2 && svidRate > 20) {
                metricsIcon = "üü°";
                metricsText = "Moderate activity";
            } else if (rpcCalls > 0 || agentConnections > 0 || svidRate > 0) {
                metricsIcon = "üîµ";
                metricsText = "Low activity";
            }
            
            document.getElementById('metrics-summary').textContent = metricsIcon;
            document.getElementById('metrics-context').textContent = metricsText;
        }
        
        async function refreshMetricsStatus() {
            try {
                // Simulate SPIRE metrics data
                // In a real implementation, this would fetch from Prometheus endpoints
                const metricsData = {
                    serverRpcCalls: Math.floor(Math.random() * 10000) + 5000,
                    agentConnections: Math.floor(Math.random() * 50) + 10,
                    svidRate: Math.floor(Math.random() * 100) + 20,
                    certExpiry: Math.floor(Math.random() * 10) + 5,
                    attestAgentCount: Math.floor(Math.random() * 500) + 100,
                    jwtSvidCount: Math.floor(Math.random() * 200) + 50,
                    x509SvidCount: Math.floor(Math.random() * 800) + 200,
                    caSignCount: Math.floor(Math.random() * 100) + 25,
                    bundleFetchCount: Math.floor(Math.random() * 150) + 30,
                    agentX509Count: Math.floor(Math.random() * 300) + 75,
                    expiringSvids: Math.floor(Math.random() * 20) + 5,
                    outdatedSvids: Math.floor(Math.random() * 10) + 2,
                    sdsConnections: Math.floor(Math.random() * 25) + 5,
                    syncEntries: Math.floor(Math.random() * 100) + 40
                };
                
                // Update summary cards
                document.getElementById('server-rpc-calls').textContent = metricsData.serverRpcCalls.toLocaleString();
                document.getElementById('agent-connections').textContent = metricsData.agentConnections;
                document.getElementById('svid-rate').textContent = metricsData.svidRate + '/min';
                document.getElementById('cert-expiry').textContent = metricsData.certExpiry;
                
                // Update detailed metrics tables
                document.getElementById('attest-agent-count').textContent = metricsData.attestAgentCount.toLocaleString();
                document.getElementById('jwt-svid-count').textContent = metricsData.jwtSvidCount.toLocaleString();
                document.getElementById('x509-svid-count').textContent = metricsData.x509SvidCount.toLocaleString();
                document.getElementById('ca-sign-count').textContent = metricsData.caSignCount.toLocaleString();
                document.getElementById('bundle-fetch-count').textContent = metricsData.bundleFetchCount.toLocaleString();
                
                document.getElementById('agent-x509-count').textContent = metricsData.agentX509Count.toLocaleString();
                document.getElementById('expiring-svids').textContent = metricsData.expiringSvids;
                document.getElementById('outdated-svids').textContent = metricsData.outdatedSvids;
                document.getElementById('sds-connections').textContent = metricsData.sdsConnections;
                document.getElementById('sync-entries').textContent = metricsData.syncEntries.toLocaleString();
                
                // Store metrics data globally for modal access
                window.currentMetricsData = metricsData;
                
                // Update overview metrics summary
                updateMetricsSummary();
                
                console.log('Metrics refreshed:', metricsData);
            } catch (error) {
                console.error('Failed to refresh metrics status:', error);
            }
        }
        
        // Modal functionality for metric drilldown
        function showMetricDetail(metricType) {
            const modal = document.getElementById('metrics-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            // Generate detailed content based on metric type
            const content = generateMetricDetailContent(metricType);
            modalTitle.textContent = content.title;
            modalBody.innerHTML = content.body;
            
            modal.style.display = 'block';
            
            // Add event listener to close modal when clicking outside
            modal.onclick = function(event) {
                if (event.target === modal) {
                    closeMetricModal();
                }
            };
        }
        
        function closeMetricModal() {
            document.getElementById('metrics-modal').style.display = 'none';
        }

        // Database Policies Modal Functions
        function showDatabasePolicies() {
            const modal = document.getElementById('database-policies-modal');
            const modalTitle = document.getElementById('policies-modal-title');
            const modalBody = document.getElementById('policies-modal-body');
            
            // Generate database policies content
            const content = generateDatabasePoliciesContent();
            modalTitle.textContent = content.title;
            modalBody.innerHTML = content.body;
            
            modal.style.display = 'block';
            
            // Add event listener to close modal when clicking outside
            modal.onclick = function(event) {
                if (event.target === modal) {
                    closeDatabasePoliciesModal();
                }
            };
        }
        
        function closeDatabasePoliciesModal() {
            document.getElementById('database-policies-modal').style.display = 'none';
        }
        
        // Add keyboard support for closing modal
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeMetricModal();
                closeDatabasePoliciesModal();
            }
        });
        
        function generateMetricDetailContent(metricType) {
            const currentData = window.currentMetricsData || {};
            
            switch(metricType) {
                case 'server-rpc':
                    return {
                        title: 'Server RPC Calls - Detailed Analysis',
                        body: `
                            <div class="metric-detail-grid">
                                <div class="metric-detail-card">
                                    <h4>Total RPC Calls</h4>
                                    <div class="metric-value-large">${(currentData.serverRpcCalls || 7234).toLocaleString()}</div>
                                    <div class="metric-trend">
                                        <span class="trend-indicator trend-up">‚Üó</span>
                                        <span>+5.2% from last hour</span>
                                    </div>
                                </div>
                                <div class="metric-detail-card">
                                    <h4>Average Response Time</h4>
                                    <div class="metric-value-large">24ms</div>
                                    <div class="metric-trend">
                                        <span class="trend-indicator trend-stable">‚Üí</span>
                                        <span>Stable performance</span>
                                    </div>
                                </div>
                                <div class="metric-detail-card">
                                    <h4>Error Rate</h4>
                                    <div class="metric-value-large">0.12%</div>
                                    <div class="metric-trend">
                                        <span class="trend-indicator trend-down">‚Üò</span>
                                        <span>-0.03% improvement</span>
                                    </div>
                                </div>
                                <div class="metric-detail-card">
                                    <h4>Peak RPC/sec</h4>
                                    <div class="metric-value-large">156</div>
                                    <div class="metric-trend">
                                        <span class="trend-indicator trend-up">‚Üó</span>
                                        <span>Highest in last 24h</span>
                                    </div>
                                </div>
                            </div>
                            <h4>RPC Call Breakdown</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>RPC Method</th>
                                        <th>Call Count</th>
                                        <th>Success Rate</th>
                                        <th>Avg Response Time</th>
                                        <th>Last Called</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>attest_agent</td>
                                        <td>${(currentData.attestAgentCount || 423).toLocaleString()}</td>
                                        <td><span class="status-online">99.8%</span></td>
                                        <td>45ms</td>
                                        <td>2 seconds ago</td>
                                    </tr>
                                    <tr>
                                        <td>fetch_x509_svid</td>
                                        <td>${(currentData.x509SvidCount || 1567).toLocaleString()}</td>
                                        <td><span class="status-online">99.9%</span></td>
                                        <td>18ms</td>
                                        <td>1 second ago</td>
                                    </tr>
                                    <tr>
                                        <td>fetch_jwt_svid</td>
                                        <td>${(currentData.jwtSvidCount || 234).toLocaleString()}</td>
                                        <td><span class="status-online">99.7%</span></td>
                                        <td>12ms</td>
                                        <td>5 seconds ago</td>
                                    </tr>
                                    <tr>
                                        <td>sign_x509_ca_svid</td>
                                        <td>${(currentData.caSignCount || 89).toLocaleString()}</td>
                                        <td><span class="status-online">100%</span></td>
                                        <td>67ms</td>
                                        <td>12 seconds ago</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="metric-chart">
                                üìä RPC Calls Timeline Chart (Requires Chart.js integration)
                            </div>
                        `
                    };
                    
                case 'agent-connections':
                    return {
                        title: 'Agent Connections - Detailed Analysis',
                        body: `
                            <div class="metric-detail-grid">
                                <div class="metric-detail-card">
                                    <h4>Active Connections</h4>
                                    <div class="metric-value-large">${currentData.agentConnections || 24}</div>
                                    <div class="metric-trend">
                                        <span class="trend-indicator trend-stable">‚Üí</span>
                                        <span>Stable over last hour</span>
                                    </div>
                                </div>
                                <div class="metric-detail-card">
                                    <h4>Connection Pool Usage</h4>
                                    <div class="metric-value-large">78%</div>
                                    <div class="metric-trend">
                                        <span class="trend-indicator trend-up">‚Üó</span>
                                        <span>+12% from baseline</span>
                                    </div>
                                </div>
                                <div class="metric-detail-card">
                                    <h4>Failed Connections</h4>
                                    <div class="metric-value-large">2</div>
                                    <div class="metric-trend">
                                        <span class="trend-indicator trend-down">‚Üò</span>
                                        <span>-3 from last hour</span>
                                    </div>
                                </div>
                                <div class="metric-detail-card">
                                    <h4>Avg Connection Duration</h4>
                                    <div class="metric-value-large">4.2h</div>
                                    <div class="metric-trend">
                                        <span class="trend-indicator trend-up">‚Üó</span>
                                        <span>Healthy session length</span>
                                    </div>
                                </div>
                            </div>
                            <h4>Agent Connection Status</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Agent ID</th>
                                        <th>Node</th>
                                        <th>Status</th>
                                        <th>Connected Since</th>
                                        <th>Last Heartbeat</th>
                                        <th>Data Transferred</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>spire-agent-79mq8</td>
                                        <td>workload-cluster-node-1</td>
                                        <td><span class="status-online">‚óè</span> Connected</td>
                                        <td>3.2h ago</td>
                                        <td>2s ago</td>
                                        <td>4.2 MB</td>
                                    </tr>
                                    <tr>
                                        <td>spire-agent-k8s4x</td>
                                        <td>workload-cluster-node-2</td>
                                        <td><span class="status-online">‚óè</span> Connected</td>
                                        <td>3.1h ago</td>
                                        <td>1s ago</td>
                                        <td>3.8 MB</td>
                                    </tr>
                                    <tr>
                                        <td>spire-agent-p9n2m</td>
                                        <td>workload-cluster-node-3</td>
                                        <td><span class="status-warning">‚óè</span> Reconnecting</td>
                                        <td>2.8h ago</td>
                                        <td>45s ago</td>
                                        <td>2.1 MB</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="metric-chart">
                                üìä Connection Timeline Chart (Requires Chart.js integration)
                            </div>
                        `
                    };
                    
                case 'svid-issuance':
                    return {
                        title: 'SVID Issuance - Detailed Analysis',
                        body: `
                            <div class="metric-detail-grid">
                                <div class="metric-detail-card">
                                    <h4>Current Issuance Rate</h4>
                                    <div class="metric-value-large">${currentData.svidRate || 67}/min</div>
                                    <div class="metric-trend">
                                        <span class="trend-indicator trend-up">‚Üó</span>
                                        <span>+15% from baseline</span>
                                    </div>
                                </div>
                                <div class="metric-detail-card">
                                    <h4>Total SVIDs Issued Today</h4>
                                    <div class="metric-value-large">12,435</div>
                                    <div class="metric-trend">
                                        <span class="trend-indicator trend-up">‚Üó</span>
                                        <span>Normal daily volume</span>
                                    </div>
                                </div>
                                <div class="metric-detail-card">
                                    <h4>X.509 vs JWT Ratio</h4>
                                    <div class="metric-value-large">85:15</div>
                                    <div class="metric-trend">
                                        <span class="trend-indicator trend-stable">‚Üí</span>
                                        <span>Typical distribution</span>
                                    </div>
                                </div>
                                <div class="metric-detail-card">
                                    <h4>Avg Issuance Time</h4>
                                    <div class="metric-value-large">120ms</div>
                                    <div class="metric-trend">
                                        <span class="trend-indicator trend-down">‚Üò</span>
                                        <span>-20ms improvement</span>
                                    </div>
                                </div>
                            </div>
                            <h4>SVID Issuance Breakdown</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>SVID Type</th>
                                        <th>Count (Last Hour)</th>
                                        <th>Success Rate</th>
                                        <th>Avg Time</th>
                                        <th>Common Selectors</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>X.509-SVID</td>
                                        <td>${(currentData.x509SvidCount || 2847).toLocaleString()}</td>
                                        <td><span class="status-online">99.9%</span></td>
                                        <td>145ms</td>
                                        <td>k8s:pod-name, k8s:namespace</td>
                                    </tr>
                                    <tr>
                                        <td>JWT-SVID</td>
                                        <td>${(currentData.jwtSvidCount || 512).toLocaleString()}</td>
                                        <td><span class="status-online">99.8%</span></td>
                                        <td>67ms</td>
                                        <td>k8s:service-account</td>
                                    </tr>
                                </tbody>
                            </table>
                            <h4>Recent Issuance Activity</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>SVID Type</th>
                                        <th>Subject</th>
                                        <th>Duration</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>2s ago</td>
                                        <td>X.509</td>
                                        <td>spiffe://example.org/workload/user-service</td>
                                        <td>112ms</td>
                                        <td><span class="status-online">‚úì</span></td>
                                    </tr>
                                    <tr>
                                        <td>5s ago</td>
                                        <td>JWT</td>
                                        <td>spiffe://example.org/workload/payment-api</td>
                                        <td>45ms</td>
                                        <td><span class="status-online">‚úì</span></td>
                                    </tr>
                                    <tr>
                                        <td>8s ago</td>
                                        <td>X.509</td>
                                        <td>spiffe://example.org/workload/inventory-service</td>
                                        <td>134ms</td>
                                        <td><span class="status-online">‚úì</span></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="metric-chart">
                                üìä SVID Issuance Rate Chart (Requires Chart.js integration)
                            </div>
                        `
                    };
                    
                case 'certificate-expiry':
                    return {
                        title: 'Certificate Expiry - Detailed Analysis',
                        body: `
                            <div class="metric-detail-grid">
                                <div class="metric-detail-card">
                                    <h4>Expiring Soon (< 24h)</h4>
                                    <div class="metric-value-large">${currentData.certExpiry || 8}</div>
                                    <div class="metric-trend">
                                        <span class="trend-indicator trend-warning">‚ö†</span>
                                        <span>Requires attention</span>
                                    </div>
                                </div>
                                <div class="metric-detail-card">
                                    <h4>Expiring This Week</h4>
                                    <div class="metric-value-large">127</div>
                                    <div class="metric-trend">
                                        <span class="trend-indicator trend-stable">‚Üí</span>
                                        <span>Normal rotation cycle</span>
                                    </div>
                                </div>
                                <div class="metric-detail-card">
                                    <h4>Auto-Renewal Success</h4>
                                    <div class="metric-value-large">99.4%</div>
                                    <div class="metric-trend">
                                        <span class="trend-indicator trend-up">‚Üó</span>
                                        <span>+0.2% improvement</span>
                                    </div>
                                </div>
                                <div class="metric-detail-card">
                                    <h4>CA Certificate Validity</h4>
                                    <div class="metric-value-large">247d</div>
                                    <div class="metric-trend">
                                        <span class="trend-indicator trend-stable">‚Üí</span>
                                        <span>Healthy CA lifespan</span>
                                    </div>
                                </div>
                            </div>
                            <h4>Certificate Expiry Timeline</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Certificate</th>
                                        <th>Type</th>
                                        <th>Subject</th>
                                        <th>Expires In</th>
                                        <th>Auto-Renew</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>cert-abc123</td>
                                        <td>SVID</td>
                                        <td>spiffe://example.org/workload/user-service</td>
                                        <td><span class="status-warning">4h 23m</span></td>
                                        <td>‚úì Enabled</td>
                                        <td><span class="status-warning">‚óè</span> Monitored</td>
                                    </tr>
                                    <tr>
                                        <td>cert-def456</td>
                                        <td>SVID</td>
                                        <td>spiffe://example.org/workload/payment-api</td>
                                        <td><span class="status-warning">18h 45m</span></td>
                                        <td>‚úì Enabled</td>
                                        <td><span class="status-online">‚óè</span> Healthy</td>
                                    </tr>
                                    <tr>
                                        <td>cert-ghi789</td>
                                        <td>CA</td>
                                        <td>SPIRE Intermediate CA</td>
                                        <td><span class="status-online">247d 12h</span></td>
                                        <td>‚úì Enabled</td>
                                        <td><span class="status-online">‚óè</span> Healthy</td>
                                    </tr>
                                </tbody>
                            </table>
                            <h4>Renewal Activity (Last 24h)</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Certificate</th>
                                        <th>Action</th>
                                        <th>New Expiry</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>2h ago</td>
                                        <td>spiffe://example.org/workload/inventory-service</td>
                                        <td>Auto-Renewed</td>
                                        <td>in 23h 45m</td>
                                        <td><span class="status-online">‚úì Success</span></td>
                                    </tr>
                                    <tr>
                                        <td>6h ago</td>
                                        <td>spiffe://example.org/workload/user-service</td>
                                        <td>Auto-Renewed</td>
                                        <td>in 17h 23m</td>
                                        <td><span class="status-online">‚úì Success</span></td>
                                    </tr>
                                    <tr>
                                        <td>14h ago</td>
                                        <td>spiffe://example.org/workload/payment-api</td>
                                        <td>Manual Renewal</td>
                                        <td>in 9h 34m</td>
                                        <td><span class="status-online">‚úì Success</span></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="metric-chart">
                                üìä Certificate Expiry Timeline Chart (Requires Chart.js integration)
                            </div>
                        `
                    };
                    
                default:
                    return {
                        title: 'Metric Details',
                        body: '<p>Metric details not available for this type.</p>'
                    };
            }
        }

        function generateDatabasePoliciesContent() {
            return {
                title: 'SPIRE Database Policies & Registration Entries',
                body: `
                    <div class="metric-detail-grid">
                        <div class="metric-detail-card">
                            <h4>Total Registration Entries</h4>
                            <div class="metric-value-large" id="total-entries">7</div>
                            <div class="metric-trend">
                                <span class="trend-indicator trend-stable">‚Üí</span>
                                <span>Active policies</span>
                            </div>
                        </div>
                        <div class="metric-detail-card">
                            <h4>Workload Services</h4>
                            <div class="metric-value-large">3</div>
                            <div class="metric-trend">
                                <span class="trend-indicator trend-online">‚óè</span>
                                <span>user-service, payment-api, inventory-service</span>
                            </div>
                        </div>
                        <div class="metric-detail-card">
                            <h4>Trust Domain</h4>
                            <div class="metric-value-large">example.org</div>
                            <div class="metric-trend">
                                <span class="trend-indicator trend-stable">‚Üí</span>
                                <span>Primary domain</span>
                            </div>
                        </div>
                        <div class="metric-detail-card">
                            <h4>Agent Entries</h4>
                            <div class="metric-value-large">1</div>
                            <div class="metric-trend">
                                <span class="trend-indicator trend-online">‚óè</span>
                                <span>Node attestation</span>
                            </div>
                        </div>
                    </div>

                    <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                        <h4 style="margin: 0 0 10px 0; color: #667eea;">üìã Database Query Commands</h4>
                        <p style="margin: 0; font-size: 14px; color: #666;">
                            Use these commands to query the PostgreSQL database directly for real-time policy data:
                        </p>
                    </div>

                    <h4>üîç Interactive Policy Search</h4>
                    <div style="margin-bottom: 20px;">
                        <input type="text" id="policy-search" placeholder="Search by SPIFFE ID, selector, or parent ID..." 
                               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                               onkeyup="filterPolicies(this.value)">
                    </div>

                    <h4>üìä SPIRE Registration Entries</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="table" id="policies-table">
                            <thead>
                                <tr>
                                    <th>Entry ID</th>
                                    <th>SPIFFE ID</th>
                                    <th>Parent ID</th>
                                    <th>Selectors</th>
                                    <th>TTL</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="policies-table-body">
                                <tr class="policy-row" data-search="spiffe://example.org/spire/agent/k8s_psat/spire-server-cluster/node-1 k8s_psat">
                                    <td><code>1</code></td>
                                    <td><strong>spiffe://example.org/spire/agent/k8s_psat/spire-server-cluster</strong></td>
                                    <td><em>spiffe://example.org/spire/server</em></td>
                                    <td><span class="selector-tag">k8s_psat:cluster:spire-server-cluster</span></td>
                                    <td>3600s</td>
                                    <td><span class="status-online">‚óè</span> Active</td>
                                </tr>
                                <tr class="policy-row" data-search="spiffe://example.org/workload/user-service k8s user-service workload user management">
                                    <td><code>2</code></td>
                                    <td><strong>spiffe://example.org/workload/user-service</strong></td>
                                    <td><em>spiffe://example.org/spire/agent/k8s_psat/spire-server-cluster</em></td>
                                    <td>
                                        <span class="selector-tag">k8s:ns:workload</span>
                                        <span class="selector-tag">k8s:sa:user-service</span>
                                        <span class="selector-tag">k8s:pod-label:service:user-management</span>
                                    </td>
                                    <td>1800s</td>
                                    <td><span class="status-online">‚óè</span> Active</td>
                                </tr>
                                <tr class="policy-row" data-search="spiffe://example.org/workload/payment-api k8s payment-api workload payment processing">
                                    <td><code>3</code></td>
                                    <td><strong>spiffe://example.org/workload/payment-api</strong></td>
                                    <td><em>spiffe://example.org/spire/agent/k8s_psat/spire-server-cluster</em></td>
                                    <td>
                                        <span class="selector-tag">k8s:ns:workload</span>
                                        <span class="selector-tag">k8s:sa:payment-api</span>
                                        <span class="selector-tag">k8s:pod-label:service:payment-processing</span>
                                    </td>
                                    <td>900s</td>
                                    <td><span class="status-online">‚óè</span> Active</td>
                                </tr>
                                <tr class="policy-row" data-search="spiffe://example.org/workload/inventory-service k8s inventory-service workload inventory management">
                                    <td><code>4</code></td>
                                    <td><strong>spiffe://example.org/workload/inventory-service</strong></td>
                                    <td><em>spiffe://example.org/spire/agent/k8s_psat/spire-server-cluster</em></td>
                                    <td>
                                        <span class="selector-tag">k8s:ns:workload</span>
                                        <span class="selector-tag">k8s:sa:inventory-service</span>
                                        <span class="selector-tag">k8s:pod-label:service:inventory-management</span>
                                    </td>
                                    <td>1800s</td>
                                    <td><span class="status-online">‚óè</span> Active</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h4>üõ†Ô∏è Database Query Commands</h4>
                    <div style="background: #f1f3f4; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <h5>Connect to PostgreSQL Database:</h5>
                        <pre style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto; font-size: 13px; margin: 10px 0;"><code># Get database pod name
DB_POD=$(kubectl --context spire-server-cluster -n spire get pod -l app=spire-db -o jsonpath='{.items[0].metadata.name}')

# Connect to PostgreSQL
kubectl --context spire-server-cluster -n spire exec -it $DB_POD -- psql -U postgres -d spire</code></pre>

                        <h5>Query Registration Entries:</h5>
                        <pre style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto; font-size: 13px; margin: 10px 0;"><code>-- List all registration entries
SELECT id, spiffe_id, parent_id, ttl, admin, downstream 
FROM registered_entries 
ORDER BY id;

-- Count entries by parent
SELECT parent_id, COUNT(*) as entry_count 
FROM registered_entries 
GROUP BY parent_id;

-- Show selectors for all entries
SELECT re.id, re.spiffe_id, s.type, s.value 
FROM registered_entries re 
JOIN selectors s ON re.id = s.registered_entry_id 
ORDER BY re.id;</code></pre>

                        <h5>Show Bundle Information:</h5>
                        <pre style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto; font-size: 13px; margin: 10px 0;"><code>-- List trust domain bundles
SELECT trust_domain, created_at, updated_at 
FROM bundles;

-- Show CA certificates
SELECT trust_domain, created_at, updated_at 
FROM ca_certificates 
ORDER BY created_at DESC;</code></pre>

                        <h5>Live Policy Refresh:</h5>
                        <pre style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto; font-size: 13px; margin: 10px 0;"><code># Get SPIRE server pod and show current entries
SERVER_POD=$(kubectl --context spire-server-cluster -n spire get pod -l app=spire-server -o jsonpath='{.items[0].metadata.name}')
kubectl --context spire-server-cluster -n spire exec $SERVER_POD -- /opt/spire/bin/spire-server entry show</code></pre>
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <h5 style="margin: 0 0 10px 0; color: #1976d2;">üí° Pro Tips</h5>
                        <ul style="margin: 5px 0; padding-left: 20px; color: #666;">
                            <li>Use the search box above to quickly find specific policies</li>
                            <li>Click on SPIFFE IDs to copy them to clipboard</li>
                            <li>Registration entries are automatically synced across all agents</li>
                            <li>TTL values determine SVID refresh frequency</li>
                        </ul>
                    </div>
                `
            };
        }

        function filterPolicies(searchTerm) {
            const rows = document.querySelectorAll('.policy-row');
            const term = searchTerm.toLowerCase();
            
            rows.forEach(row => {
                const searchData = row.getAttribute('data-search').toLowerCase();
                if (searchData.includes(term)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update visible count
            const visibleRows = document.querySelectorAll('.policy-row[style=""]').length;
            const totalRows = rows.length;
            const emptyRows = document.querySelectorAll('.policy-row[style*="none"]').length;
            
            if (searchTerm && emptyRows === totalRows) {
                // Show "no results" message
                let noResultsRow = document.getElementById('no-results-row');
                if (!noResultsRow) {
                    noResultsRow = document.createElement('tr');
                    noResultsRow.id = 'no-results-row';
                    noResultsRow.innerHTML = '<td colspan="6" style="text-align: center; color: #666; font-style: italic;">No policies found matching "' + searchTerm + '"</td>';
                    document.getElementById('policies-table-body').appendChild(noResultsRow);
                }
                noResultsRow.style.display = '';
            } else {
                const noResultsRow = document.getElementById('no-results-row');
                if (noResultsRow) {
                    noResultsRow.style.display = 'none';
                }
            }
        }
        
        // Initialize with some default data and start auto-refresh
        window.onload = function() {
            refreshStatus();
            refreshServerStatus();
            refreshDatabaseStatus();
            refreshAgentStatus();
            refreshWorkloadStatus();
            refreshMetricsStatus();
            updateRefreshInterval(); // Start auto-refresh with default 10s interval
        };
        
        // Modal functionality for kubectl describe drilldown
        function showResourceDetails(resourceType, resourceName, namespace, context) {
            const modal = document.getElementById('resourceModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalCommand = document.getElementById('modalCommand');
            const modalOutput = document.getElementById('modalOutput');
            
            // Show modal with loading state
            modal.style.display = 'block';
            modalTitle.textContent = `${resourceType}: ${resourceName}`;
            modalCommand.textContent = `kubectl --context ${context} -n ${namespace} describe ${resourceType} ${resourceName}`;
            modalOutput.innerHTML = '<div class="loading-spinner"></div> Loading resource details...';
            
            // Fetch describe output
            const url = `/api/describe/${resourceType}/${namespace}/${context}/${resourceName}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        modalOutput.innerHTML = `<div style="color: #dc3545;">Error: ${data.error}</div><div style="margin-top: 10px; font-size: 11px; color: #6c757d;">Command: ${data.command || 'Unknown'}</div>`;
                    } else {
                        modalOutput.textContent = data.output;
                    }
                })
                .catch(error => {
                    console.error('Error fetching resource details:', error);
                    modalOutput.innerHTML = `<div style="color: #dc3545;">Failed to load resource details: ${error.message}</div>`;
                });
        }
        
        function closeModal() {
            document.getElementById('resourceModal').style.display = 'none';
        }
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('resourceModal');
            if (event.target === modal) {
                closeModal();
            }
        }
        
        // Helper function to determine resource context and namespace
        function getResourceContext(resourceName) {
            if (resourceName.startsWith('spire-server') || resourceName.startsWith('spire-db') || resourceName.startsWith('postgres')) {
                return { context: 'spire-server-cluster', namespace: 'spire-server' };
            } else if (resourceName.startsWith('spire-agent')) {
                return { context: 'workload-cluster', namespace: 'spire-system' };
            } else {
                // Workload services
                return { context: 'workload-cluster', namespace: 'production' };
            }
        }
        
        // Create clickable pod name
        function createClickablePodName(podName) {
            const context = getResourceContext(podName);
            return `<span class="clickable-pod-name" onclick="showResourceDetails('pod', '${podName}', '${context.namespace}', '${context.context}')" title="Click to view details">${podName}</span>`;
        }
        
    </script>
    
    <!-- Modal for kubectl describe output -->
    <div id="resourceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Resource Details</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="command-info">
                    <strong>Command:</strong> <span id="modalCommand"></span>
                </div>
                <div class="describe-output" id="modalOutput">
                    Loading...
                </div>
            </div>
        </div>
    </div>
</body>
</html>