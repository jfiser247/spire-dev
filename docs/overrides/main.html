{% extends "base.html" %}

{% block scripts %}
  {{ super() }}
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      if (typeof mermaid !== 'undefined') {
        console.log('Mermaid loaded, initializing...');
        mermaid.initialize({
          startOnLoad: true,
          theme: 'default',
          securityLevel: 'loose',
          themeVariables: {
            primaryColor: '#1976d2',
            primaryTextColor: '#ffffff',
            primaryBorderColor: '#1976d2',
            lineColor: '#1976d2',
            secondaryColor: '#f5f5f5',
            tertiaryColor: '#e8f4fd'
          },
          flowchart: {
            useMaxWidth: true,
            htmlLabels: true
          }
        });

        // Find all mermaid code blocks and convert them
        const mermaidBlocks = document.querySelectorAll('pre.mermaid code, .mermaid');
        console.log('Found ' + mermaidBlocks.length + ' potential Mermaid blocks');
        
        mermaidBlocks.forEach(function(block, index) {
          if (block.tagName === 'CODE' && block.parentElement.classList.contains('mermaid')) {
            // Convert code block to div for mermaid processing
            const mermaidDiv = document.createElement('div');
            mermaidDiv.className = 'mermaid';
            mermaidDiv.textContent = block.textContent;
            mermaidDiv.id = 'mermaid-' + index;
            block.parentElement.parentNode.replaceChild(mermaidDiv, block.parentElement);
          } else if (block.classList.contains('mermaid')) {
            // Already a mermaid div, just ensure it has an ID
            if (!block.id) {
              block.id = 'mermaid-' + index;
            }
          }
        });

        // Re-scan for mermaid divs and render
        const finalMermaidDivs = document.querySelectorAll('.mermaid');
        console.log('Processing ' + finalMermaidDivs.length + ' Mermaid diagrams');
        
        if (finalMermaidDivs.length > 0) {
          try {
            mermaid.init(undefined, '.mermaid');
            console.log('Mermaid diagrams initialized successfully');
          } catch (error) {
            console.error('Mermaid initialization error:', error);
          }
        }
      } else {
        console.error('Mermaid library not loaded');
      }
    });
  </script>
{% endblock %}